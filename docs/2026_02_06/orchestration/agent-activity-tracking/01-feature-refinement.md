# Step 1: Feature Request Refinement

**Status**: Completed
**Timestamp**: 2026-02-06

## Original Request

Add persistent agent activity tracking to workflow steps by creating a database schema and persistence layer that captures all tool call events (tool name, input parameters, tool use ID, start/stop timestamps, duration) along with token usage metrics (input tokens, output tokens, cache read/write tokens, estimated cost) from the Claude Agent SDK stream during workflow step execution. Currently, all agent activity data (StreamToolEvent objects, text deltas, thinking content) is 100% ephemeral — it only exists in React state during active streaming via the useClarificationStream hook and is lost when the user navigates away. The goal is to persist this activity to SQLite so users can leave a running workflow, return later, and review the complete agent activity history for each step in the workflow streaming panel. The real-time streaming behavior should remain unchanged for live viewing, but the panel should also be able to load and display historical activity from the database when the user returns to a completed or previously-viewed step. This requires: a new agent_activity database table (linked to workflow_steps via foreign key) storing individual tool events with their full metadata including token usage and cost, updates to the Electron main process streaming services (like AgentSdkExecutor.processStreamEvent and clarification-step.service) to persist events as they stream, a new repository for querying historical activity, React Query hooks for loading persisted activity, and UI updates to the workflow-streaming-panel to render historical tool events alongside or in place of the live stream when historical data is available. The agent activity panel tabs (Clarification, Refinement, Discovery, Planning) should each show their step's full historical tool call timeline with all metadata (tool name, inputs, duration, token counts, estimated cost) when viewing completed steps.

## Refined Request

Add persistent agent activity tracking to workflow steps by creating a new `agent_activity` table in `db/schema/` following the existing Drizzle ORM conventions (snake_case columns, mandatory `id`, `createdAt`, `updatedAt` fields) with a foreign key referencing the `workflow_steps` table's `id` column, storing individual tool call events with columns for tool name, JSON-serialized input parameters, tool use ID, start and stop timestamps (integer Unix milliseconds matching the project's timestamp pattern), computed duration, and token usage metrics (input tokens, output tokens, cache creation input tokens, cache read input tokens, and estimated cost as a real column), along with an event type discriminator to distinguish tool calls from text deltas and thinking content. A corresponding `agent-activity.repository.ts` in `db/repositories/` should expose `create()`, `getByStepId()`, and `getByWorkflowId()` methods following the factory-function repository pattern used by `workflows.repository.ts` and `steps.repository.ts`. On the Electron main process side, the `AgentSdkExecutor.processStreamEvent()` method in `electron/services/agent-step/agent-sdk-executor.ts` and the step-specific services (`clarification-step.service.ts`, `refinement-step.service.ts`, and the file discovery and planning step services) must be updated to intercept `StreamEvent` objects — specifically `tool_use` start/stop events and `message_delta` events carrying usage metadata from the Claude Agent SDK stream — and persist them to SQLite via the new repository through IPC handlers registered in `electron/ipc/`. New query keys should be added to the existing query key factory in `lib/queries/` (alongside the existing `steps` and `workflows` keys), and a `use-agent-activity.ts` hook in `hooks/queries/` should wrap `useQuery` calls that fetch historical activity by step ID through a new `window.electron.agentActivity.getByStepId()` IPC channel. The `workflow-streaming-panel.tsx` component and its per-phase tab contents (Clarification, Refinement, Discovery, Planning) should be updated to check whether a step is actively streaming (via the existing Zustand pipeline store's `isStreaming` state) and, if not, fall back to loading persisted activity from the database using the new React Query hook, rendering a historical tool call timeline that displays each event's tool name, truncated input parameters, duration, token counts, and estimated cost in the same visual format as the live `StreamToolEvent` rendering — ensuring that the current real-time streaming behavior driven by ephemeral React state in `useClarificationStream` and its sibling hooks remains completely unchanged for live viewing, while completed or previously-navigated-away-from steps reconstruct their full agent activity history from SQLite.

## Analysis

- **Original word count**: ~280 words
- **Refined word count**: ~380 words
- **Expansion ratio**: ~1.4x
- **Intent preserved**: Yes - core feature unchanged, technical details enriched with project-specific patterns
- **Format**: Single paragraph as required
